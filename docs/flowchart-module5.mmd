flowchart TD
    %% ========================================
    %% MODULE 5 - NETTOYAGE POST-ESCRIPTORIUM
    %% ========================================

    START([üßπ MODULE 5<br/>Nettoyage Post-eScriptorium])

    %% ========================================
    %% IMPORT ET STOCKAGE
    %% ========================================
    IMPORT[üì• Import XML Pages<br/>depuis eScriptorium]
    STOCKAGE[‚òÅÔ∏è Stockage sur Seafile<br/>avec ID dans le titre<br/>Format: ID_NomManuscrit.xml]
    EXPORT[üì§ Export pour<br/>traitement local]

    START --> IMPORT
    IMPORT --> STOCKAGE
    STOCKAGE --> EXPORT

    %% ========================================
    %% D√âCISION LAYOUT
    %% ========================================
    DECISION{Quel type<br/>de layout ?}

    EXPORT --> DECISION

    %% ========================================
    %% BRANCHE SIMPLE PAGE
    %% ========================================
    subgraph SIMPLE_FLOW [üìÑ Simple Page - 1 r√©gion Main]
        SIMPLE_TITLE[üìÑ Une seule r√©gion Main<br/>par page]
        SIMPLE_COMMUNES[üîß Regex communes<br/>Corrections standard]
        SIMPLE_SPECIFIQUES[üîß Regex sp√©cifiques<br/>√† l'√©dition/manuscrit]
        SIMPLE_APPLY[‚ñ∂Ô∏è Application<br/>sur r√©gion Main]

        SIMPLE_TITLE --> SIMPLE_COMMUNES
        SIMPLE_TITLE --> SIMPLE_SPECIFIQUES
        SIMPLE_COMMUNES --> SIMPLE_APPLY
        SIMPLE_SPECIFIQUES --> SIMPLE_APPLY
    end

    %% ========================================
    %% BRANCHE DEUX PAGES
    %% ========================================
    subgraph DEUX_FLOW [üìÑüìÑ Deux Pages - 2 r√©gions Main]
        DEUX_TITLE[üìÑüìÑ Deux r√©gions Main<br/>par page<br/>Recto-Verso ou colonnes]
        DEUX_COMMUNES[üîß Regex communes<br/>Corrections standard]
        DEUX_SPECIFIQUES[üîß Regex sp√©cifiques<br/>√† l'√©dition/manuscrit]
        DEUX_APPLY[‚ñ∂Ô∏è Application<br/>sur les 2 r√©gions Main]

        DEUX_TITLE --> DEUX_COMMUNES
        DEUX_TITLE --> DEUX_SPECIFIQUES
        DEUX_COMMUNES --> DEUX_APPLY
        DEUX_SPECIFIQUES --> DEUX_APPLY
    end

    %% ========================================
    %% BRANCHE QUATRE PAGES
    %% ========================================
    subgraph QUATRE_FLOW [üìÑüìÑ<br/>üìÑüìÑ Quatre Pages - 4 r√©gions Main]
        QUATRE_TITLE[üìÑüìÑüìÑüìÑ Quatre r√©gions Main<br/>par page<br/>Layout complexe]
        QUATRE_COMMUNES[üîß Regex communes<br/>Corrections standard]
        QUATRE_SPECIFIQUES[üîß Regex sp√©cifiques<br/>√† l'√©dition/manuscrit]
        QUATRE_APPLY[‚ñ∂Ô∏è Application<br/>sur les 4 r√©gions Main]

        QUATRE_TITLE --> QUATRE_COMMUNES
        QUATRE_TITLE --> QUATRE_SPECIFIQUES
        QUATRE_COMMUNES --> QUATRE_APPLY
        QUATRE_SPECIFIQUES --> QUATRE_APPLY
    end

    %% ========================================
    %% CONNEXIONS PRINCIPALES
    %% ========================================
    DECISION -->|1 r√©gion| SIMPLE_TITLE
    DECISION -->|2 r√©gions| DEUX_TITLE
    DECISION -->|4 r√©gions| QUATRE_TITLE

    %% ========================================
    %% V√âRIFICATION ET FINALISATION
    %% ========================================
    VERIFICATION[‚úÖ V√©rification<br/>Correspondance des pages<br/>D√©tection de bugs]
    CORRECTIONS{Erreurs<br/>d√©tect√©es ?}
    CORRECTION_MANUELLE[‚úçÔ∏è Corrections<br/>manuelles]
    VERSION_FINALE[‚ú® Version finale<br/>des transcriptions<br/>au format XML Page]

    SIMPLE_APPLY --> VERIFICATION
    DEUX_APPLY --> VERIFICATION
    QUATRE_APPLY --> VERIFICATION

    VERIFICATION --> CORRECTIONS
    CORRECTIONS -->|Oui| CORRECTION_MANUELLE
    CORRECTIONS -->|Non| VERSION_FINALE
    CORRECTION_MANUELLE --> VERIFICATION

    OUTPUT([üì§ SORTIE MODULE 5<br/>Transcriptions finalis√©es])

    VERSION_FINALE --> OUTPUT

    %% ========================================
    %% D√âTAIL DES REGEX
    %% ========================================
    subgraph REGEX_DETAIL [üîß Types de Regex Appliqu√©es]
        REGEX_TITLE[üìã Cat√©gories de corrections]

        subgraph REGEX_COMMUNES [Regex Communes]
            R1[Normalisation espaces<br/>Doubles espaces ‚Üí Simple]
            R2[Correction ponctuation<br/>Espaces avant/apr√®s]
            R3[Normalisation sauts de ligne<br/>Coh√©rence des retours]
            R4[Suppression caract√®res parasites<br/>Artefacts OCR/HTR]
        end

        subgraph REGEX_SPECIFIQUES [Regex Sp√©cifiques]
            R5[Abbr√©viations latines<br/>Expansion selon contexte]
            R6[Num√©rotation canons<br/>Normalisation format]
            R7[Titres et rubriques<br/>Balisage sp√©cifique]
            R8[Annotations marginales<br/>Traitement s√©par√©]
        end
    end

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1[üí° Simple page:<br/>La plus courante<br/>1 texte continu<br/>Traitement rapide]
    note2[üí° Deux pages:<br/>Recto-verso scann√© ensemble<br/>ou texte en 2 colonnes<br/>Attention √† l'ordre]
    note3[üí° Quatre pages:<br/>Layout complexe<br/>Plusieurs colonnes + notes<br/>Traitement minutieux]
    note4[üí° V√©rification:<br/>Contr√¥le pagination<br/>D√©tection erreurs OCR<br/>Coh√©rence globale]
    note5[üí° Regex:<br/>Automatise 90% nettoyage<br/>Scripts Python personnalis√©s<br/>R√©utilisables]

    SIMPLE_TITLE -.-> note1
    DEUX_TITLE -.-> note2
    QUATRE_TITLE -.-> note3
    VERIFICATION -.-> note4
    SIMPLE_COMMUNES -.-> note5

    %% ========================================
    %% STATISTIQUES
    %% ========================================
    subgraph STATS [üìä Statistiques Indicatives]
        S1[Simple page: ~70% des documents]
        S2[Deux pages: ~25% des documents]
        S3[Quatre pages: ~5% des documents]
        S4[Taux erreurs d√©tect√©es: ~5-10%]
        S5[Temps nettoyage: 1-4h par document]
    end

    %% ========================================
    %% OUTILS
    %% ========================================
    subgraph TOOLS [üõ†Ô∏è Outils Utilis√©s]
        T1[Python: Scripts regex]
        T2[lxml: Manipulation XML]
        T3[Scripts personnalis√©s]
        T4[Validation XSD]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef import fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef stockage fill:#bbdefb,stroke:#1976d2,stroke-width:2px
    classDef simple fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef deux fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef quatre fill:#ffccbc,stroke:#d84315,stroke-width:2px
    classDef regex fill:#e1bee7,stroke:#8e24aa,stroke-width:2px
    classDef verification fill:#b2dfdb,stroke:#00796b,stroke-width:2px
    classDef finale fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5
    classDef title fill:#e0e0e0,stroke:#757575,stroke-width:2px

    class START,OUTPUT startEnd
    class DECISION,CORRECTIONS decision
    class IMPORT,EXPORT import
    class STOCKAGE stockage
    class SIMPLE_TITLE,SIMPLE_COMMUNES,SIMPLE_SPECIFIQUES,SIMPLE_APPLY simple
    class DEUX_TITLE,DEUX_COMMUNES,DEUX_SPECIFIQUES,DEUX_APPLY deux
    class QUATRE_TITLE,QUATRE_COMMUNES,QUATRE_SPECIFIQUES,QUATRE_APPLY quatre
    class R1,R2,R3,R4,R5,R6,R7,R8 regex
    class VERIFICATION,CORRECTION_MANUELLE verification
    class VERSION_FINALE finale
    class note1,note2,note3,note4,note5 note
    class REGEX_TITLE title

    style SIMPLE_FLOW fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style DEUX_FLOW fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    style QUATRE_FLOW fill:#fbe9e7,stroke:#d84315,stroke-width:2px
    style REGEX_DETAIL fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px,stroke-dasharray: 5 5
    style REGEX_COMMUNES fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style REGEX_SPECIFIQUES fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style STATS fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
    style TOOLS fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 3 3
