flowchart TD
    %% ========================================
    %% VUE D'ENSEMBLE - ARCHITECTURE COMPLÃˆTE
    %% ========================================

    START([ğŸš€ DÃ‰BUT DU PIPELINE])

    %% ========================================
    %% MODULE 1 - RÃ©cupÃ©ration de manuscrits
    %% ========================================
    subgraph MODULE1 [ğŸ“œ MODULE 1 - RÃ©cupÃ©ration de manuscrits]
        M1_DECISION{Source ?}
        M1_ACHAT[ğŸ’° Achat]
        M1_SCRAPING[ğŸŒ Scraping Web]
        M1_OUTPUT[ğŸ“¦ Manuscrits numÃ©risÃ©s]

        M1_DECISION -->|DÃ©jÃ  numÃ©risÃ©s| M1_ACHAT
        M1_DECISION -->|Pas numÃ©risÃ©s| M1_ACHAT
        M1_DECISION -->|En ligne| M1_SCRAPING
        M1_ACHAT --> M1_OUTPUT
        M1_SCRAPING --> M1_OUTPUT
    end

    %% ========================================
    %% MODULE 2 - MÃ©thodes de tÃ©lÃ©chargement
    %% ========================================
    subgraph MODULE2 [ğŸ“¥ MODULE 2 - MÃ©thodes de tÃ©lÃ©chargement]
        M2_DECISION{MÃ©thode ?}
        M2_IIIF[ğŸ–¼ï¸ IIIF]
        M2_PDF[ğŸ“„ PDF]
        M2_COMPLEXE[âš™ï¸ MÃ©thodes complexes]
        M2_SEAFILE[â˜ï¸ Seafile<br/>Stockage Cloud]

        M2_DECISION -->|IIIF disponible| M2_IIIF
        M2_DECISION -->|PDF seulement| M2_PDF
        M2_DECISION -->|MÃ©thode spÃ©ciale| M2_COMPLEXE
        M2_IIIF -->|Bonne qualitÃ©| M2_SEAFILE
        M2_PDF -->|QualitÃ© variable| M2_SEAFILE
        M2_COMPLEXE -->|Haute qualitÃ©| M2_SEAFILE
    end

    %% ========================================
    %% MODULE 3 - RÃ©cupÃ©ration d'Ã©ditions
    %% ========================================
    subgraph MODULE3 [ğŸ“š MODULE 3 - RÃ©cupÃ©ration d'Ã©ditions]
        M3_DECISION{Source ?}
        M3_LIBRE[ğŸŒ Libre de droit]
        M3_BNU[ğŸ›ï¸ BNU]
        M3_ACHAT[ğŸ’° Achat]
        M3_CATEG[ğŸ“‹ CatÃ©gorisation]
        M3_OUTPUT[ğŸ“¦ Ã‰ditions numÃ©risÃ©es]

        M3_DECISION -->|Internet| M3_LIBRE
        M3_DECISION -->|PrÃªt| M3_BNU
        M3_DECISION -->|Achat| M3_ACHAT
        M3_LIBRE --> M3_CATEG
        M3_BNU --> M3_CATEG
        M3_ACHAT --> M3_CATEG
        M3_CATEG -->|15e-20e s.<br/>Jamais sortie<br/>20e-21e s.| M3_OUTPUT
    end

    %% ========================================
    %% MODULE 4 - Traitement eScriptorium
    %% ========================================
    subgraph MODULE4 [âš™ï¸ MODULE 4 - Traitement eScriptorium]
        M4_INPUT[ğŸ“¥ Images + mÃ©tadonnÃ©es]
        M4_DECISION{Type ?}
        M4_EDITIONS[ğŸ“– Ã‰ditions]
        M4_MANUSCRITS[ğŸ“œ Manuscrits]

        M4_SEG[ğŸ”² Segmentation<br/>HPC Training]
        M4_TRANS[âœï¸ Transcription<br/>HPC Training]

        M4_OUTPUT[ğŸ“„ XML Pages]

        M4_INPUT --> M4_DECISION
        M4_DECISION -->|Ã‰ditions| M4_EDITIONS
        M4_DECISION -->|Manuscrits| M4_MANUSCRITS

        M4_EDITIONS --> M4_SEG
        M4_EDITIONS --> M4_TRANS
        M4_MANUSCRITS --> M4_SEG
        M4_MANUSCRITS --> M4_TRANS

        M4_SEG --> M4_OUTPUT
        M4_TRANS --> M4_OUTPUT
    end

    %% ========================================
    %% MODULE 5 - Nettoyage et finalisation
    %% ========================================
    subgraph MODULE5 [ğŸ§¹ MODULE 5 - Nettoyage Post-eScriptorium]
        M5_INPUT[ğŸ“¥ Import XML Pages]
        M5_SEAFILE[â˜ï¸ Stockage Seafile]
        M5_DECISION{Layout ?}
        M5_SIMPLE[ğŸ“„ Simple page]
        M5_DEUX[ğŸ“„ğŸ“„ Deux pages]
        M5_QUATRE[ğŸ“„ğŸ“„<br/>ğŸ“„ğŸ“„ Quatre pages]
        M5_REGEX[ğŸ”§ Application Regex]
        M5_VERIF[âœ… VÃ©rification]
        M5_OUTPUT[âœ¨ Version finale XML Pages]

        M5_INPUT --> M5_SEAFILE
        M5_SEAFILE --> M5_DECISION
        M5_DECISION -->|1 rÃ©gion| M5_SIMPLE
        M5_DECISION -->|2 rÃ©gions| M5_DEUX
        M5_DECISION -->|4 rÃ©gions| M5_QUATRE
        M5_SIMPLE --> M5_REGEX
        M5_DEUX --> M5_REGEX
        M5_QUATRE --> M5_REGEX
        M5_REGEX --> M5_VERIF
        M5_VERIF --> M5_OUTPUT
    end

    %% ========================================
    %% MODULE SPÃ‰CIAL - DÃ©cret de Gratien
    %% ========================================
    subgraph DECRET [âš–ï¸ MODULE SPÃ‰CIAL - DÃ©cret de Gratien]
        DG_INPUT1[ğŸ“¥ XML Pages]
        DG_INPUT2[ğŸ“¥ Friedberg + MÃ¼nchener]
        DG_ALLEGATIONS[ğŸ“Š AllÃ©gations CSV]
        DG_ENRICHISSEMENT[âœ¨ Enrichissement]
        DG_OUTPUT[ğŸ“¦ DÃ©cret enrichi]

        DG_INPUT1 --> DG_ALLEGATIONS
        DG_INPUT2 --> DG_ENRICHISSEMENT
        DG_ALLEGATIONS --> DG_ENRICHISSEMENT
        DG_ENRICHISSEMENT --> DG_OUTPUT
    end

    %% ========================================
    %% CONNEXIONS INTER-MODULES
    %% ========================================
    START --> MODULE1
    START --> MODULE3

    M1_OUTPUT -->|Export localâ†’Cloud| M2_SEAFILE
    M3_OUTPUT -->|Export localâ†’Cloud| M2_SEAFILE

    M2_SEAFILE -->|Export images| M4_INPUT

    M4_OUTPUT --> M5_INPUT
    M4_OUTPUT -.->|ParallÃ¨le| DG_INPUT1

    M5_OUTPUT --> DG_INPUT2

    DG_OUTPUT --> END

    END([ğŸ¯ DONNÃ‰ES FINALES])

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1[ğŸ’¡ QualitÃ© cible Ã‰ditions:<br/>CER 0.1-2%]
    note2[ğŸ’¡ QualitÃ© cible Manuscrits:<br/>CER 4-8%]
    note3[ğŸ’¡ Formats supportÃ©s:<br/>IIIF, PDF, TIF, JPG]

    M4_EDITIONS -.-> note1
    M4_MANUSCRITS -.-> note2
    M2_SEAFILE -.-> note3

    %% ========================================
    %% LÃ‰GENDE
    %% ========================================
    subgraph LEGEND [ğŸ“– LÃ‰GENDE]
        LEG1[ğŸ’° Processus d'achat]
        LEG2{DÃ©cision}
        LEG3[â˜ï¸ Stockage cloud]
        LEG4[âš™ï¸ Traitement automatique]
        LEG5[âœ… Validation manuelle]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef moduleAcquisition fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    classDef moduleTelechargement fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef moduleEditions fill:#f3e5f5,stroke:#6a1b9a,stroke-width:3px
    classDef moduleTraitement fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef moduleNettoyage fill:#fce4ec,stroke:#c2185b,stroke-width:3px
    classDef moduleDecret fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef cloud fill:#bbdefb,stroke:#1976d2,stroke-width:2px
    classDef output fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5

    class MODULE1 moduleAcquisition
    class MODULE2 moduleTelechargement
    class MODULE3 moduleEditions
    class MODULE4 moduleTraitement
    class MODULE5 moduleNettoyage
    class DECRET moduleDecret
    class M1_DECISION,M2_DECISION,M3_DECISION,M4_DECISION,M5_DECISION decision
    class M2_SEAFILE,M5_SEAFILE cloud
    class M1_OUTPUT,M3_OUTPUT,M4_OUTPUT,M5_OUTPUT,DG_OUTPUT output
    class START,END startEnd
    class note1,note2,note3 note

    style LEGEND fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
