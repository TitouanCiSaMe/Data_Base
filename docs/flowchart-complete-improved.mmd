flowchart TD
    %% ========================================
    %% PIPELINE COMPLET - VERSION AM√âLIOR√âE
    %% ========================================

    START([üöÄ D√âBUT DU PIPELINE])

    %% ========================================
    %% MODULE 1 & 3 - ACQUISITION (PARALL√àLE)
    %% ========================================
    subgraph ACQUISITION [üì• ACQUISITION DE DONN√âES]
        ACQ_MS{Manuscrits}
        ACQ_ED{√âditions}

        %% Manuscrits
        ACQ_MS_ACHAT[üí∞ Achat]
        ACQ_MS_SCRAPING[üåê Scraping]
        ACQ_MS -->|D√©j√† num√©ris√©| ACQ_MS_ACHAT
        ACQ_MS -->|En ligne| ACQ_MS_SCRAPING

        %% √âditions
        ACQ_ED_LIBRE[üåê Libre acc√®s]
        ACQ_ED_BNU[üèõÔ∏è BNU]
        ACQ_ED -->|Gratuit| ACQ_ED_LIBRE
        ACQ_ED -->|Pr√™t/Achat| ACQ_ED_BNU
    end

    START --> ACQ_MS
    START --> ACQ_ED

    %% ========================================
    %% MODULE 2 - T√âL√âCHARGEMENT
    %% ========================================
    subgraph TELECHARGEMENT [üì• T√âL√âCHARGEMENT]
        DL_DECISION{M√©thode ?}
        DL_IIIF[üñºÔ∏è IIIF<br/>‚≠ê‚≠ê‚≠ê]
        DL_PDF[üìÑ PDF<br/>‚≠ê‚≠ê]
        DL_HEXA[üî¢ Hexad√©cimal<br/>‚≠ê‚≠ê‚≠ê‚≠ê]
        DL_TUILES[üß© Tuiles<br/>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê]

        DL_DECISION -->|Standard| DL_IIIF
        DL_DECISION -->|Simple| DL_PDF
        DL_DECISION -->|British Lib| DL_HEXA
        DL_DECISION -->|Haute qualit√©| DL_TUILES
    end

    ACQ_MS_SCRAPING --> DL_DECISION
    ACQ_MS_ACHAT -.->|D√©j√† t√©l√©charg√©| SEAFILE
    ACQ_ED_LIBRE --> DL_DECISION
    ACQ_ED_BNU -.->|Num√©risation BNU| SEAFILE

    %% Point de convergence
    SEAFILE[‚òÅÔ∏è SEAFILE<br/>Stockage Cloud Universitaire]

    DL_IIIF --> SEAFILE
    DL_PDF --> SEAFILE
    DL_HEXA --> SEAFILE
    DL_TUILES --> SEAFILE

    %% ========================================
    %% MODULE 4 - TRAITEMENT ESCRIPTORIUM
    %% ========================================
    subgraph ESCRIPTORIUM [‚öôÔ∏è TRAITEMENT ESCRIPTORIUM]
        ESC_INPUT[üì• Import images]
        ESC_TYPE{Type ?}

        %% Workflow g√©n√©rique
        ESC_SEG[üî≤ Segmentation]
        ESC_SEG_DECISION{Mod√®le<br/>existe ?}
        ESC_SEG_MANUEL[‚úçÔ∏è Manuel<br/>50-100 pages]
        ESC_SEG_HPC[üéì HPC Training]
        ESC_SEG_APPLY[‚ñ∂Ô∏è Application]

        ESC_TRANS[‚úçÔ∏è Transcription]
        ESC_TRANS_DECISION{Mod√®le<br/>existe ?}
        ESC_TRANS_MANUEL[‚úçÔ∏è Manuel<br/>100-200 lignes]
        ESC_TRANS_HPC[üéì HPC Training]
        ESC_TRANS_APPLY[‚ñ∂Ô∏è Application]

        ESC_INPUT --> ESC_TYPE
        ESC_TYPE -->|√âditions<br/>CER: 0.1-2%| ESC_SEG
        ESC_TYPE -->|Manuscrits<br/>CER: 4-8%| ESC_SEG

        ESC_SEG --> ESC_SEG_DECISION
        ESC_SEG_DECISION -->|Non| ESC_SEG_MANUEL
        ESC_SEG_DECISION -->|Oui| ESC_SEG_APPLY
        ESC_SEG_MANUEL --> ESC_SEG_HPC
        ESC_SEG_HPC --> ESC_SEG_APPLY

        ESC_SEG_APPLY --> ESC_TRANS
        ESC_TRANS --> ESC_TRANS_DECISION
        ESC_TRANS_DECISION -->|Non| ESC_TRANS_MANUEL
        ESC_TRANS_DECISION -->|Oui| ESC_TRANS_APPLY
        ESC_TRANS_MANUEL --> ESC_TRANS_HPC
        ESC_TRANS_HPC --> ESC_TRANS_APPLY
    end

    SEAFILE -->|Export images| ESC_INPUT

    %% D√©tail HPC
    subgraph HPC_DETAIL [üñ•Ô∏è HPC - High Performance Computing]
        HPC_1[üì¶ Upload: Images + XML + Script]
        HPC_2[üéì Fine-tuning GPU]
        HPC_3[üì• Export meilleur mod√®le]
        HPC_1 --> HPC_2 --> HPC_3
    end

    ESC_SEG_HPC -.-> HPC_DETAIL
    ESC_TRANS_HPC -.-> HPC_DETAIL

    %% Sortie eScriptorium
    XML_PAGES[üìÑ XML Pages<br/>Format PageXML]
    ESC_TRANS_APPLY --> XML_PAGES

    %% ========================================
    %% MODULE 5 - NETTOYAGE
    %% ========================================
    subgraph NETTOYAGE [üßπ NETTOYAGE POST-TRAITEMENT]
        NET_IMPORT[üì• Import XML]
        NET_STOCKAGE[‚òÅÔ∏è Stockage Seafile]
        NET_LAYOUT{Layout ?}
        NET_1[üìÑ 1 r√©gion]
        NET_2[üìÑüìÑ 2 r√©gions]
        NET_4[üìÑüìÑüìÑüìÑ 4 r√©gions]
        NET_REGEX[üîß Application Regex<br/>Communes + Sp√©cifiques]
        NET_VERIF[‚úÖ V√©rification]
        NET_FINAL[‚ú® Version finale]

        NET_IMPORT --> NET_STOCKAGE
        NET_STOCKAGE --> NET_LAYOUT
        NET_LAYOUT -->|Simple| NET_1
        NET_LAYOUT -->|Double| NET_2
        NET_LAYOUT -->|Complexe| NET_4
        NET_1 --> NET_REGEX
        NET_2 --> NET_REGEX
        NET_4 --> NET_REGEX
        NET_REGEX --> NET_VERIF
        NET_VERIF --> NET_FINAL
    end

    XML_PAGES --> NET_IMPORT

    %% ========================================
    %% MODULE D√âCRET DE GRATIEN
    %% ========================================
    subgraph DECRET [‚öñÔ∏è D√âCRET DE GRATIEN]
        %% Branche All√©gations
        DG_OCHOA[üìö Ochoa & Diez<br/>All√©gations]
        DG_ALGO[‚öôÔ∏è Extraction]
        DG_ALLEG_CSV[üìä All√©gations.csv]

        %% Branche Friedberg
        DG_FRIEDBERG[üìñ Friedberg +<br/>M√ºnchener]
        DG_CANONS[üì§ Extraction canons]
        DG_STRUCTURE[üóÇÔ∏è Structuration<br/>hi√©rarchique]

        %% Enrichissement
        DG_ENRICHISSEMENT[‚ú® Enrichissement<br/>avec ID]
        DG_OUTPUT[‚öñÔ∏è D√©cret enrichi]

        DG_OCHOA --> DG_ALGO
        DG_ALGO --> DG_ALLEG_CSV
        DG_FRIEDBERG --> DG_CANONS
        DG_CANONS --> DG_STRUCTURE
        DG_ALLEG_CSV --> DG_ENRICHISSEMENT
        DG_STRUCTURE --> DG_ENRICHISSEMENT
        DG_ENRICHISSEMENT --> DG_OUTPUT
    end

    XML_PAGES -.->|Parall√®le| DG_OCHOA
    NET_FINAL --> DG_FRIEDBERG

    %% ========================================
    %% SORTIE FINALE
    %% ========================================
    END([üéØ DONN√âES FINALES<br/>Corpus complet])

    NET_FINAL --> END
    DG_OUTPUT --> END

    %% ========================================
    %% ANNOTATIONS CL√âS
    %% ========================================
    note1[üí° Qualit√© images:<br/>300-600 DPI<br/>Format: TIF/JPG]
    note2[üí° CER √âditions: 0.1-2%<br/>CER Manuscrits: 4-8%]
    note3[üí° Regex: 90% automatis√©<br/>Scripts Python]
    note4[üí° ~4000 canons<br/>~3800 all√©gations]

    SEAFILE -.-> note1
    ESC_TYPE -.-> note2
    NET_REGEX -.-> note3
    DG_OUTPUT -.-> note4

    %% ========================================
    %% L√âGENDE
    %% ========================================
    subgraph LEGEND [üìñ L√âGENDE]
        L1{D√©cision / Choix}
        L2[Processus automatique]
        L3[‚úçÔ∏è Intervention manuelle]
        L4[‚òÅÔ∏è Stockage cloud]
        L5[üéì Entra√Ænement ML]
    end

    %% ========================================
    %% STATISTIQUES GLOBALES
    %% ========================================
    subgraph STATS [üìä M√âTRIQUES GLOBALES]
        ST1[Pipeline complet: 2-6 mois]
        ST2[Volume donn√©es: 50-500 GB]
        ST3[Taux automatisation: ~85%]
        ST4[Pr√©cision finale: >95%]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef acquisition fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef telechargement fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef cloud fill:#bbdefb,stroke:#1976d2,stroke-width:3px
    classDef escriptorium fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef hpc fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef xml fill:#ffccbc,stroke:#d84315,stroke-width:2px
    classDef nettoyage fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef decret fill:#f8bbd0,stroke:#c2185b,stroke-width:2px
    classDef final fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5
    classDef manuel fill:#ffab91,stroke:#d84315,stroke-width:2px

    class START,END startEnd
    class ACQ_MS,ACQ_ED,DL_DECISION,ESC_TYPE,ESC_SEG_DECISION,ESC_TRANS_DECISION,NET_LAYOUT decision
    class ACQ_MS_ACHAT,ACQ_MS_SCRAPING,ACQ_ED_LIBRE,ACQ_ED_BNU acquisition
    class DL_IIIF,DL_PDF,DL_HEXA,DL_TUILES telechargement
    class SEAFILE,NET_STOCKAGE cloud
    class ESC_INPUT,ESC_SEG,ESC_SEG_APPLY,ESC_TRANS,ESC_TRANS_APPLY escriptorium
    class ESC_SEG_HPC,ESC_TRANS_HPC,HPC_1,HPC_2,HPC_3 hpc
    class XML_PAGES xml
    class NET_IMPORT,NET_LAYOUT,NET_1,NET_2,NET_4,NET_REGEX,NET_VERIF nettoyage
    class NET_FINAL,DG_OUTPUT final
    class DG_OCHOA,DG_ALGO,DG_ALLEG_CSV,DG_FRIEDBERG,DG_CANONS,DG_STRUCTURE,DG_ENRICHISSEMENT decret
    class note1,note2,note3,note4 note
    class ESC_SEG_MANUEL,ESC_TRANS_MANUEL manuel

    style ACQUISITION fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    style TELECHARGEMENT fill:#fff3e0,stroke:#e65100,stroke-width:3px
    style ESCRIPTORIUM fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    style HPC_DETAIL fill:#fff8e1,stroke:#f57f17,stroke-width:2px,stroke-dasharray: 5 5
    style NETTOYAGE fill:#f3e5f5,stroke:#6a1b9a,stroke-width:3px
    style DECRET fill:#fce4ec,stroke:#c2185b,stroke-width:3px
    style LEGEND fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
    style STATS fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 3 3
