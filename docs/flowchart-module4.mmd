flowchart TD
    %% ========================================
    %% MODULE 4 - TRAITEMENT ESCRIPTORIUM
    %% ========================================

    START([‚öôÔ∏è MODULE 4<br/>Traitement eScriptorium])

    IMPORT[üì• Import des images<br/>depuis Seafile]

    START --> IMPORT

    %% ========================================
    %% D√âCISION TYPE DE DOCUMENT
    %% ========================================
    DECISION{Type de<br/>document ?}

    IMPORT --> DECISION

    %% ========================================
    %% BRANCHE √âDITIONS
    %% ========================================
    subgraph EDITIONS_FLOW [üìñ Workflow √âditions]
        ED_START[üìñ √âditions imprim√©es<br/>Texte r√©gulier]

        %% Segmentation
        ED_SEG_TITLE[üî≤ SEGMENTATION]
        ED_SEG_CHOICE{Mod√®le<br/>disponible ?}
        ED_SEG_MANUEL[‚úçÔ∏è Segmentation manuelle<br/>50-100 pages]
        ED_SEG_REUSE[‚ôªÔ∏è R√©utilisation<br/>mod√®le existant]
        ED_SEG_TRAIN[üéì Entra√Ænement HPC]
        ED_SEG_APPLY[‚ñ∂Ô∏è Application du mod√®le<br/>sur toutes les pages]
        ED_SEG_VALID[‚úÖ Validation et<br/>ajustements manuels]
        ED_SEG_RESULT[‚úÖ Segmentation compl√®te<br/>Donn√©es propres]

        %% Transcription
        ED_TRANS_TITLE[‚úçÔ∏è TRANSCRIPTION]
        ED_TRANS_CHOICE{Mod√®le<br/>disponible ?}
        ED_TRANS_MANUEL[‚úçÔ∏è Transcription manuelle<br/>100-200 lignes corrig√©es]
        ED_TRANS_REUSE[‚ôªÔ∏è R√©utilisation<br/>mod√®le existant]
        ED_TRANS_TRAIN[üéì Entra√Ænement HPC]
        ED_TRANS_APPLY[‚ñ∂Ô∏è Application du mod√®le<br/>sur tout le texte]
        ED_TRANS_VALID[‚úÖ Validation et<br/>corrections]
        ED_TRANS_RESULT[‚úÖ Transcription compl√®te<br/>CER: 0.1-2%]

        ED_START --> ED_SEG_TITLE
        ED_SEG_TITLE --> ED_SEG_CHOICE
        ED_SEG_CHOICE -->|Non| ED_SEG_MANUEL
        ED_SEG_CHOICE -->|Oui| ED_SEG_REUSE
        ED_SEG_MANUEL --> ED_SEG_TRAIN
        ED_SEG_TRAIN --> ED_SEG_APPLY
        ED_SEG_REUSE --> ED_SEG_APPLY
        ED_SEG_APPLY --> ED_SEG_VALID
        ED_SEG_VALID --> ED_SEG_RESULT

        ED_SEG_RESULT --> ED_TRANS_TITLE
        ED_TRANS_TITLE --> ED_TRANS_CHOICE
        ED_TRANS_CHOICE -->|Non| ED_TRANS_MANUEL
        ED_TRANS_CHOICE -->|Oui| ED_TRANS_REUSE
        ED_TRANS_MANUEL --> ED_TRANS_TRAIN
        ED_TRANS_TRAIN --> ED_TRANS_APPLY
        ED_TRANS_REUSE --> ED_TRANS_APPLY
        ED_TRANS_APPLY --> ED_TRANS_VALID
        ED_TRANS_VALID --> ED_TRANS_RESULT
    end

    %% ========================================
    %% BRANCHE MANUSCRITS
    %% ========================================
    subgraph MANUSCRITS_FLOW [üìú Workflow Manuscrits]
        MS_START[üìú Manuscrits<br/>√âcriture manuscrite]

        %% Segmentation
        MS_SEG_TITLE[üî≤ SEGMENTATION]
        MS_SEG_CHOICE{Mod√®le<br/>disponible ?}
        MS_SEG_MANUEL[‚úçÔ∏è Segmentation manuelle<br/>50-100 pages]
        MS_SEG_REUSE[‚ôªÔ∏è R√©utilisation<br/>mod√®le existant]
        MS_SEG_TRAIN[üéì Entra√Ænement HPC]
        MS_SEG_APPLY[‚ñ∂Ô∏è Application du mod√®le<br/>sur toutes les pages]
        MS_SEG_VALID[‚úÖ Validation et<br/>ajustements manuels]
        MS_SEG_RESULT[‚úÖ Segmentation compl√®te<br/>Donn√©es propres]

        %% Transcription
        MS_TRANS_TITLE[‚úçÔ∏è TRANSCRIPTION]
        MS_TRANS_CHOICE{Mod√®le<br/>disponible ?}
        MS_TRANS_MANUEL[‚úçÔ∏è Transcription manuelle<br/>100-200 lignes corrig√©es]
        MS_TRANS_REUSE[‚ôªÔ∏è R√©utilisation<br/>mod√®le existant]
        MS_TRANS_TRAIN[üéì Entra√Ænement HPC]
        MS_TRANS_APPLY[‚ñ∂Ô∏è Application du mod√®le<br/>sur tout le texte]
        MS_TRANS_VALID[‚úÖ Validation et<br/>corrections]
        MS_TRANS_RESULT[‚ö†Ô∏è Transcription compl√®te<br/>CER: 4-8%]

        MS_START --> MS_SEG_TITLE
        MS_SEG_TITLE --> MS_SEG_CHOICE
        MS_SEG_CHOICE -->|Non| MS_SEG_MANUEL
        MS_SEG_CHOICE -->|Oui| MS_SEG_REUSE
        MS_SEG_MANUEL --> MS_SEG_TRAIN
        MS_SEG_TRAIN --> MS_SEG_APPLY
        MS_SEG_REUSE --> MS_SEG_APPLY
        MS_SEG_APPLY --> MS_SEG_VALID
        MS_SEG_VALID --> MS_SEG_RESULT

        MS_SEG_RESULT --> MS_TRANS_TITLE
        MS_TRANS_TITLE --> MS_TRANS_CHOICE
        MS_TRANS_CHOICE -->|Non| MS_TRANS_MANUEL
        MS_TRANS_CHOICE -->|Oui| MS_TRANS_REUSE
        MS_TRANS_MANUEL --> MS_TRANS_TRAIN
        MS_TRANS_TRAIN --> MS_TRANS_APPLY
        MS_TRANS_REUSE --> MS_TRANS_APPLY
        MS_TRANS_APPLY --> MS_TRANS_VALID
        MS_TRANS_VALID --> MS_TRANS_RESULT
    end

    %% ========================================
    %% D√âTAIL ENTRA√éNEMENT HPC
    %% ========================================
    subgraph HPC_DETAIL [üñ•Ô∏è D√©tail Entra√Ænement HPC]
        HPC_INPUT[üì¶ Donn√©es d'entr√©e:<br/>Images + XML Pages<br/>+ Script.sh]
        HPC_CONNECT[üîó Connexion HPC<br/>via commandes Bash]
        HPC_UPLOAD[üì§ Upload des donn√©es<br/>sur le cluster]
        HPC_FINETUNE[üéì Fine-tuning<br/>du mod√®le]
        HPC_MONITOR[üìä Monitoring<br/>et compilation]
        HPC_SELECT[üèÜ S√©lection du<br/>meilleur mod√®le]
        HPC_EXPORT[üì• Export du mod√®le<br/>vers eScriptorium]

        HPC_INPUT --> HPC_CONNECT
        HPC_CONNECT --> HPC_UPLOAD
        HPC_UPLOAD --> HPC_FINETUNE
        HPC_FINETUNE --> HPC_MONITOR
        HPC_MONITOR --> HPC_SELECT
        HPC_SELECT --> HPC_EXPORT
    end

    %% ========================================
    %% CONNEXIONS PRINCIPALES
    %% ========================================
    DECISION -->|√âditions| ED_START
    DECISION -->|Manuscrits| MS_START

    ED_SEG_TRAIN -.->|D√©tails| HPC_DETAIL
    ED_TRANS_TRAIN -.->|D√©tails| HPC_DETAIL
    MS_SEG_TRAIN -.->|D√©tails| HPC_DETAIL
    MS_TRANS_TRAIN -.->|D√©tails| HPC_DETAIL

    %% ========================================
    %% SORTIE
    %% ========================================
    CONVERGENCE[üìÑ XML Pages<br/>Format standard PageXML]

    ED_TRANS_RESULT --> CONVERGENCE
    MS_TRANS_RESULT --> CONVERGENCE

    OUTPUT([üì§ SORTIE MODULE 4<br/>Vers Nettoyage Post-traitement])

    CONVERGENCE --> OUTPUT

    %% ========================================
    %% ANNOTATIONS
    %% ========================================
    note1[üí° √âditions:<br/>Plus facile √† traiter<br/>Texte r√©gulier et imprim√©<br/>CER cible: 0.1-2%]
    note2[üí° Manuscrits:<br/>Plus complexe<br/>√âcriture manuscrite variable<br/>CER cible: 4-8%]
    note3[üí° HPC:<br/>High Performance Computing<br/>Entra√Ænement sur GPU<br/>Dur√©e: 2-8 heures]
    note4[üí° R√©utilisation:<br/>Gain de temps consid√©rable<br/>Si manuscrit similaire trait√©<br/>Mod√®le partag√©]
    note5[üí° XML Pages:<br/>Format standard<br/>Contient texte + coordonn√©es<br/>M√©tadonn√©es pr√©serv√©es]

    ED_TRANS_RESULT -.-> note1
    MS_TRANS_RESULT -.-> note2
    HPC_DETAIL -.-> note3
    ED_SEG_REUSE -.-> note4
    CONVERGENCE -.-> note5

    %% ========================================
    %% L√âGENDE CER
    %% ========================================
    subgraph CER_LEGEND [üìä CER - Character Error Rate]
        CER1[0.1-2%: Excellent - √âditions]
        CER2[4-8%: Bon - Manuscrits]
        CER3[>10%: N√©cessite retraitement]
    end

    %% ========================================
    %% STYLES
    %% ========================================
    classDef startEnd fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    classDef decision fill:#ffeb3b,stroke:#f57f17,stroke-width:2px
    classDef edition fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef manuscrit fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef manuel fill:#ffccbc,stroke:#d84315,stroke-width:2px
    classDef reuse fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef hpc fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef validation fill:#b2dfdb,stroke:#00796b,stroke-width:2px
    classDef result fill:#a5d6a7,stroke:#2e7d32,stroke-width:2px
    classDef convergence fill:#bbdefb,stroke:#1976d2,stroke-width:3px
    classDef note fill:#fff9c4,stroke:#f57f17,stroke-width:1px,stroke-dasharray: 5 5
    classDef title fill:#e0e0e0,stroke:#757575,stroke-width:2px

    class START,OUTPUT startEnd
    class DECISION,ED_SEG_CHOICE,ED_TRANS_CHOICE,MS_SEG_CHOICE,MS_TRANS_CHOICE decision
    class ED_START,ED_SEG_APPLY,ED_TRANS_APPLY edition
    class MS_START,MS_SEG_APPLY,MS_TRANS_APPLY manuscrit
    class ED_SEG_MANUEL,ED_TRANS_MANUEL,MS_SEG_MANUEL,MS_TRANS_MANUEL manuel
    class ED_SEG_REUSE,ED_TRANS_REUSE,MS_SEG_REUSE,MS_TRANS_REUSE reuse
    class ED_SEG_TRAIN,ED_TRANS_TRAIN,MS_SEG_TRAIN,MS_TRANS_TRAIN,HPC_INPUT,HPC_CONNECT,HPC_UPLOAD,HPC_FINETUNE,HPC_MONITOR,HPC_SELECT,HPC_EXPORT hpc
    class ED_SEG_VALID,ED_TRANS_VALID,MS_SEG_VALID,MS_TRANS_VALID validation
    class ED_SEG_RESULT,ED_TRANS_RESULT,MS_SEG_RESULT,MS_TRANS_RESULT result
    class CONVERGENCE convergence
    class note1,note2,note3,note4,note5 note
    class ED_SEG_TITLE,ED_TRANS_TITLE,MS_SEG_TITLE,MS_TRANS_TITLE title

    style EDITIONS_FLOW fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    style MANUSCRITS_FLOW fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    style HPC_DETAIL fill:#fff3e0,stroke:#e65100,stroke-width:2px,stroke-dasharray: 5 5
    style CER_LEGEND fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 3 3
